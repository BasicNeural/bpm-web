<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPM Tapper Full</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #ff4757;
            --bg-color: #1e272e; /* 다크 테마로 몰입감 향상 */
            --text-color: #ffffff;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* 스크롤 방지 */
            background-color: var(--bg-color);
            font-family: -apple-system, system-ui, sans-serif;
            color: var(--text-color);
        }

        /* 전체 레이아웃: 위-중간-아래 3단 구성 */
        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100dvh; /* Dynamic Viewport Height 사용 */
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
        }

        /* 상단: BPM 수치 표시 */
        .header {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #bpm-display {
            font-size: 6rem;
            font-weight: 900;
            color: var(--primary-color);
            text-shadow: 0 0 20px rgba(255, 71, 87, 0.4);
        }

        .unit {
            font-size: 1.2rem;
            color: #808e9b;
            letter-spacing: 2px;
        }

        /* 중간: 거대한 터치 영역 */
        .tap-area {
            flex: 5;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #tap-btn {
            width: 80vw;
            height: 80vw;
            max-width: 300px;
            max-height: 300px;
            border-radius: 50%;
            border: 8px solid rgba(255, 71, 87, 0.2);
            background-color: var(--primary-color);
            color: white;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 0 50px rgba(255, 71, 87, 0.3);
            cursor: pointer;
            transition: transform 0.05s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #tap-btn:active {
            transform: scale(0.9);
            background-color: #ff6b81;
        }

        /* 하단: 그래프 영역 */
        .footer {
            flex: 2.5;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .chart-container {
            width: 100%;
            height: 100%;
        }

        /* 리셋 버튼 (플로팅) */
        #reset-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #808e9b;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

<div class="app-container">
    <button id="reset-btn" onclick="reset()">RESET</button>

    <div class="header">
        <div id="bpm-display">0</div>
        <div class="unit">BPM (5s AVG)</div>
    </div>
    
    <div class="tap-area">
        <div id="tap-btn">TAP</div>
    </div>
    
    <div class="footer">
        <div class="chart-container">
            <canvas id="bpmChart"></canvas>
        </div>
    </div>
</div>

<script>
    let tapTimes = [];
    let bpmData = [];
    let labels = [];
    let count = 0;

    const bpmDisplay = document.getElementById('bpm-display');
    const tapBtn = document.getElementById('tap-btn');
    const ctx = document.getElementById('bpmChart').getContext('2d');

    // Chart.js 설정 (다크 모드 최적화)
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: bpmData,
                borderColor: '#ff4757',
                borderWidth: 3,
                fill: true,
                backgroundColor: 'rgba(255, 71, 87, 0.1)',
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    min: 40, max: 200, 
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#808e9b' }
                },
                x: { display: false }
            },
            plugins: { legend: { display: false } },
            animation: { duration: 150 }
        }
    });

    // 터치 반응 속도 극대화
    tapBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleTap();
    });
    
    // PC 브라우저 테스트용
    tapBtn.addEventListener('mousedown', (e) => {
        if (e.button === 0) handleTap();
    });

    function handleTap() {
        const now = Date.now();
        tapTimes.push(now);
        
        const windowSize = 5000; 
        tapTimes = tapTimes.filter(time => now - time <= windowSize);
        
        const bpm = calculateBPM();
        if (bpm > 0) {
            updateChart(bpm);
        }
    }

    function calculateBPM() {
        if (tapTimes.length < 2) return 0;
        const duration = (tapTimes[tapTimes.length - 1] - tapTimes[0]) / 1000;
        if (duration <= 0) return 0;
        const bpm = Math.round((tapTimes.length - 1) * 60 / duration);
        bpmDisplay.innerText = bpm;
        return bpm;
    }

    function updateChart(bpm) {
        count++;
        labels.push(count);
        bpmData.push(bpm);
        if (bpmData.length > 30) {
            labels.shift();
            bpmData.shift();
        }
        chart.update('none'); // 애니메이션 없이 즉시 업데이트하여 성능 확보
    }

    function reset() {
        tapTimes = [];
        bpmData.length = 0;
        labels.length = 0;
        count = 0;
        bpmDisplay.innerText = '0';
        chart.update();
    }
</script>

</body>
</html>